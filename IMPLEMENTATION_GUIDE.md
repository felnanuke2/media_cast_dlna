# DLNA Media Cast Plugin Implementation Guide

## Overview

Based on the jUPnP and CyberGarage UPnP documentation, I've created a comprehensive Pigeon-based Flutter plugin for DLNA/UPnP media casting. This implementation covers all the essential DLNA functionality for device discovery, media server browsing, and media renderer control.

## What Has Been Built

### 1. Pigeon API Definition (`pigeons/media_cast_dlna.dart`)

The Pigeon file defines a complete API that covers:

#### Core Data Models:
- **DlnaDevice**: Represents UPnP devices with all metadata (UDN, friendly name, IP, etc.)
- **DlnaService**: Represents UPnP services (AVTransport, ContentDirectory, RenderingControl)
- **MediaItem**: Represents media content with metadata (title, artist, URI, MIME type, etc.)
- **PlaybackInfo**: Current playback state and position information
- **VolumeInfo**: Volume level and mute status
- **TransportState**: Enum for playback states (stopped, playing, paused, etc.)

#### Host API (MediaCastDlnaApi):
- **Discovery Methods**: `startDiscovery()`, `stopDiscovery()`, `getDiscoveredDevices()`
- **Media Server Methods**: `browseContentDirectory()`, `searchContentDirectory()`
- **Media Renderer Control**: `play()`, `pause()`, `stop()`, `seek()`, `setMediaUri()`
- **Volume Control**: `setVolume()`, `getVolumeInfo()`, `setMute()`
- **Event Subscription**: `subscribeToEvents()`, `unsubscribeFromEvents()`

#### Flutter APIs (Callbacks):
- **DeviceDiscoveryApi**: Device discovery events
- **MediaRendererEventsApi**: Playback state changes, position updates
- **MediaServerEventsApi**: Content directory updates

### 2. Dart Controller (`lib/src/media_cast_dlna_controller.dart`)

A high-level controller that provides:
- Singleton pattern for easy access
- Stream-based event handling
- Convenience methods for common operations
- Automatic event subscription management
- Type-safe API with proper error handling

### 3. Updated Library Structure

- **Main export**: `lib/media_cast_dlna.dart` exports both Pigeon APIs and controller
- **Platform interface**: Generated by Pigeon, handles method channel communication
- **Example app**: Complete demo showing device discovery, selection, and media control

### 4. Generated Platform Code

Pigeon has generated:
- **Android**: `android/src/main/kotlin/.../MediaCastDlnaPigeon.kt`
- **iOS**: `ios/Classes/MediaCastDlnaPigeon.swift`
- **Dart**: `lib/src/media_cast_dlna_pigeon.dart`

## Native Implementation Requirements

### Android Implementation (Kotlin)

You need to implement the `MediaCastDlnaApi` interface using jUPnP:

```kotlin
class MediaCastDlnaPlugin : FlutterPlugin, MediaCastDlnaApi {
    private lateinit var upnpService: UpnpService
    private lateinit var deviceDiscoveryApi: DeviceDiscoveryApi
    private val discoveredDevices = mutableMapOf<String, DlnaDevice>()
    
    // Initialize jUPnP
    private fun initializeUpnp() {
        upnpService = UpnpServiceImpl()
        upnpService.registry.addListener(createRegistryListener())
    }
    
    // Implement all MediaCastDlnaApi methods
    override fun startDiscovery(options: DiscoveryOptions) {
        upnpService.controlPoint.search(STAllHeader())
    }
    
    // ... implement other methods
}
```

Key jUPnP components to use:
- **UpnpService**: Main UPnP stack
- **ControlPoint**: For sending actions to devices
- **Registry**: For device discovery and management
- **ActionInvocation**: For executing UPnP actions
- **SubscriptionCallback**: For event subscriptions

### iOS Implementation (Swift)

You need to implement the `MediaCastDlnaApi` protocol using CocoaUPnP or similar:

```swift
class MediaCastDlnaPlugin: NSObject, FlutterPlugin, MediaCastDlnaApi {
    private var upnpManager: UPnPManager?
    private var deviceDiscoveryApi: DeviceDiscoveryApi?
    
    // Initialize UPnP
    func initializeUpnp() {
        upnpManager = UPnPManager()
        upnpManager?.delegate = self
    }
    
    // Implement all MediaCastDlnaApi methods
    func startDiscovery(options: DiscoveryOptions) throws {
        upnpManager?.startDiscovery()
    }
    
    // ... implement other methods
}
```

## DLNA/UPnP Service Types

Your implementation should handle these standard UPnP service types:

### Media Renderer Services:
- **AVTransport** (`urn:schemas-upnp-org:service:AVTransport:1`)
  - Actions: `SetAVTransportURI`, `Play`, `Pause`, `Stop`, `Seek`, `Next`, `Previous`
  - State Variables: `TransportState`, `CurrentTrackURI`, `RelativeTimePosition`

- **RenderingControl** (`urn:schemas-upnp-org:service:RenderingControl:1`)
  - Actions: `SetVolume`, `GetVolume`, `SetMute`, `GetMute`
  - State Variables: `Volume`, `Mute`

### Media Server Services:
- **ContentDirectory** (`urn:schemas-upnp-org:service:ContentDirectory:1`)
  - Actions: `Browse`, `Search`
  - State Variables: `ContainerUpdateIDs`, `SystemUpdateID`

### Device Types:
- **MediaRenderer**: `urn:schemas-upnp-org:device:MediaRenderer:1`
- **MediaServer**: `urn:schemas-upnp-org:device:MediaServer:1`

## Implementation Steps

### 1. Add Dependencies

**Android** (`android/build.gradle`):
```gradle
dependencies {
    implementation 'org.jupnp:jupnp-core:2.7.1'
    implementation 'org.jupnp:jupnp-support:2.7.1'
}
```

**iOS** (`ios/media_cast_dlna.podspec`):
```ruby
s.dependency 'CocoaUPnP', '~> 1.0'
# or another iOS UPnP library
```

### 2. Implement Native APIs

Follow the interface defined in the generated Pigeon files:
- Handle device discovery with SSDP
- Implement SOAP action execution
- Set up GENA event subscriptions
- Manage device state and metadata

### 3. Handle DIDL-Lite Metadata

For media content, you'll need to parse and generate DIDL-Lite XML:

```xml
<?xml version="1.0" encoding="utf-8"?>
<DIDL-Lite xmlns:dc="http://purl.org/dc/elements/1.1/" 
           xmlns:upnp="urn:schemas-upnp-org:metadata-1-0/upnp/" 
           xmlns="urn:schemas-upnp-org:metadata-1-0/DIDL-Lite/">
  <item id="1" parentID="0" restricted="1">
    <dc:title>Video Title</dc:title>
    <upnp:class>object.item.videoItem</upnp:class>
    <res protocolInfo="http-get:*:video/mp4:*">http://example.com/video.mp4</res>
  </item>
</DIDL-Lite>
```

### 4. Error Handling

Implement comprehensive error handling for:
- Network connectivity issues
- UPnP device errors
- SOAP action failures
- Invalid media URIs

### 5. Testing

The example app provides a complete testing interface:
- Device discovery and listing
- Media renderer selection
- Playback control with real-time updates
- Error display and handling

## Usage Example

```dart
// Initialize
final controller = MediaCastDlnaController.instance;

// Start discovery
await controller.startDiscovery();

// Listen for devices
controller.onDeviceDiscovered.listen((device) {
  print('Found device: ${device.friendlyName}');
});

// Get renderers
final renderers = await controller.getMediaRenderers();

// Play media
await controller.playMedia(
  renderers.first.udn,
  'http://example.com/video.mp4',
);

// Control playback
await controller.play(renderers.first.udn);
await controller.pause(renderers.first.udn);
await controller.setVolume(renderers.first.udn, 50);
```

## Next Steps

1. **Implement the native Android code** using jUPnP library
2. **Implement the native iOS code** using CocoaUPnP or similar
3. **Add proper permissions** to AndroidManifest.xml and Info.plist
4. **Test with real DLNA devices** like smart TVs, media players, etc.
5. **Handle edge cases** like network changes, device disconnections
6. **Optimize performance** for device discovery and media streaming

The Pigeon API provides a solid foundation that follows UPnP/DLNA standards and should work well with both jUPnP (Android) and iOS UPnP libraries. The generated code handles all the Flutter/native communication, so you can focus on the actual UPnP implementation.
